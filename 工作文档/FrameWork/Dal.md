### 一、概述

DAL是一个数据库访问框架，通过DAL Cluster提供数据库访问

DAL Cluster可以简单理解为包含n个数据库完整连接信息的配置文件，通过这种配置文件，可以获取到数据库的连接信息，从而为应用创建数据源



### 二、使用指南

首先你要保证你的应用有访问数据库的权限，这个在pass平台区申请

Dal是依赖于Framework Foundation的环境配置，所以要设置好相应的server.properties文件

其次就是maven的依赖引入，我们还是建议使用Dal作为ORM框架



**重要的配置文件**

1、Dal.config 

是DAL的核心配置文件，包含逻辑数据库和物理数据库的映射，以及DAL客户端的配置项

这个可以放在本地的resource下，当然也可以放qconfig上 本地config优先级是更高的

最重要的还是把你的db集群名称配上



2、datasource.properties

这个是主要是一些数据库连接池相关属性，如果你不需要自己定义连接池属性，那其实不用配置这个文件，因为不配置的情况下会自动拉取全局默认配置

在qconfig上有个继承文件，我们可以继承下来然后改一些自己的配置



### 三、使用流程

- 架构、DB评审
- 申请数据库
- 使用codegen生成特定数据库访问代码
- 将代码放入项目
- 运行&测试





### 四、常用API

**参数**

1、DalHints

会保留Dal处理的上下文或中间数据，每次调用DAL的API时请重新生成DalHints的实例



2、sql

这里可以是一个标准sql，也可以是where条件，DAL根据开头是否命中关键词来判断是否为完整sql，例如select、delete等等

支持？占位符，参数顺序要和？顺序一一对应



3、SQLArg

作用：

- 对于敏感参数需要先使用SQLArg.value封装，然后调用senstive()
- 可以用SQLArg.list传参,做到动态参数



4、SQLResult

- type 返回值映射类型
- mapper 自定义结果集映射
- keyHolder 保存主键
- sorter 排序
- page 分页参数



5、Object... args

与sql中参数一一对应



**单表API**

通过DalOperationsFactory获取DalTableOperations







### 五、运行流程

**初始化**

- 获取、解析Dal.config配置文件
- 根据配置的Titan Key，从Titan服务器获取数据库连接串
- 根据连接串，创建连接池



**跑SQL**

DAL将请求路由到对应DB，从连接池获取一个连接，响应后将连接归还给连接池，并将响应结果转化为特定对象返回



### 六、数据库集群架构方案

![image-20231204115204931](D:\Users\haoxiang_zhang\AppData\Roaming\Typora\typora-user-images\image-20231204115204931.png)

我们主流采用读写分离+分片的方式来进行存储，这和Redis集群其实大同小异

既可以保证几十亿的数据正常承载，MHA来做故障转移



这个分片算法其实大致上可以分为两类：

- 范围 即根据主键id范围划分
- hash 主键id取模



**引申-一致性Hash算法**

分布式系统的负载均衡算法

我们先分析一下Hash算法，有个致命的问题是如果节点数量发生了变化，也就是在对系统做扩容或缩容的时候，必须迁移改变了映射关系的数据，最坏的情况下所有数据都需要迁移，所以我们需要一个新的算法，来避免分布式系统在扩容或缩容时发生过多的数据迁移



这个新的算法即一致性哈希算法

1、普通的hash算法是对节点数量取余，但一致性hash会对2^32进行取模运算，是一个固定的值

2、一致性hash会进行两步哈希 第一步先对存储节点做哈希索引（例如根据节点IP进行哈希）第二步对数据进行hash，因此它是将存储节点和数据都映射到一个首尾相连的哈希环上，数据哈希结果值往顺时针方向找到的第一个节点即存储改数据的节点



这样一来，当节点增删时仅仅是该节点在哈希环上顺时针相邻的后继节点需要变更



单一致性hash算法并不能保证节点能够在哈希环上分布均匀，这可能会导致有大量请求集中到一个节点上，这会容易引起雪崩的连锁反应



那么如何让节点分布均匀呢？

一种思路是有大量的节点，节点越多哈希环上的节点分布就越均匀，但实际中我们没有那么多节点于是就加入虚拟节点，即对一个真实节点做多个副本

具体实现：我们将虚拟节点映射到哈希环上，并将虚拟节点映射到实际节点，所以这里有两层映射关系



并且虚拟节点还能提高系统的稳定性，当有节点变化时会有不同的节点共同分担系统的变化因此稳定性更高



**负载均衡策略**

其实轮询这类策略只能使用于每个节点数据都相同的场景，访问任意节点都能请求到数据，但不适用分布式系统，因为分布式系统意味着数据水平切分到了不同的节点

















