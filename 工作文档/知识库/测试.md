## Mockito+Junit

### 一、概述

Mockito是一种java Mock框架，主要用来做Mock测试，我们可以用它来写单元测试，它提供了一组简单而强大的API来创建和管理模拟对象，此外还提供了丰富的验证和断言功能



@InjectMocks注解

会那个mock对象注入进spy对象

然后是开启mock注解功能，然后就是对代码进行百分百覆盖率，对于try-catch考虑两种情况，抛异常/不抛异常



### 基本概念

1、Mock对象与Spy对象

Mock的原理是通过bytebuddy修改字节码进行的代理

Spy对象：是另一种不同类型的Mock对象

区别在于，Mock对象对于不stub的方法会返回默认值，而Spy会调用真实方法，但对于stub的方法，都会执行stub逻辑，两者可以对类、接口进行模拟

我们一般会将Spy只会模拟被测试类，而Mock会模拟被测试类或其依赖



2、方法stub&参数匹配

调用某个方法时的行为stubbing

doXxx().when().someMethod Spy/mock

when(obj.someMethiod).thenXxx mock



如果我们相对某一类通用的进行模拟，可以用ArgumentMatchers.any去封装

verift校验调用次数

thenCallRealMethod()：对Mock对象stub，让它调用真正的原始方法



3、injectMocks

若@InjectMocks声明的变量要用到Mock/Spy对象，Mockito会自动将当前类的mock或spy成员

进行按类型或名字注入





### 常用API

如果模拟的时候想设置成任意的字符串、这种需求

其实Mockito里有anyString,anyList这种











## Jmeter

Jmeter是Apache下的性能测试工具，用于测试部署在服务器端应用程序的性能

### 使用教程

下载成功后，我们运行jmeter.bat即可启动JMeter

我们首先添加虚拟用户组，因为JMeter是由Java实现的，并且使用一个Java线程来模拟一个用户，因此线程组就是指一组用户的意思

设置线程组参数：

1、Number of Threads 虚拟用户数 

2、Ramp-up period（seconds）即虚拟用户增长时长，也就是用户访问时间

3、Loop Count 循环次数 即一个虚拟用户做完一遍事情后结束



定义完用户后，我们对这个线程组添加要测试的功能

即添加取样器--http请求

在这里具体定义 IP 端口 路径 请求参数 这些

要注意 通常建议设置HTTP消息头管理器，方便我们设置



接着为了方便查看请求结果、我们可以添加结果监听器

add listener --- View Results Tree

这样在测试运行完毕后我们可以通过这个视图结果树看到一些请求信息和响应数据



## 性能分析

### 怎么查看对象的内存大小

背景：对全量表进行了本地缓存，需要评估对JVM内存的影响，查看数据的内存大小占比

我们可以使用Java的内存分析工具（例如：Java VisualVM或Memory Analyzer）来进行查看

分析的方式有两种：可以基于Heap Dump文件或是实时内存分析

通过内存分析工具将Dump文件转为可视化界面和分析功能



**Heap Dump文件**

即堆转储文件，可以理解为堆的一次快照，是一个二进制文件，包含了JVM堆中所有对象的状态和信息

方便我们通过内存分析工具进行分析，但要注意生成过程会对应用程序性能造成影响，因为生成过程中JVM会暂停应用程序的执行

---如何获取？

1. 启动时添加JVM参数-XX:+HeapDumpOnOutOfMemoryError,这样发生OOM后自动转储一份，我们可以指定快照的存储路径以及OOM时的动作比如重启tomcat
2. 使用jmap参数，jmap -dump 将会立即生成堆转储快照到指定位置



**Memory Analyzer**

用于分析heap dump文件，可以来分析内存泄漏问题、或是对内存使用情况进行分析

再介绍几个MAT常用的功能







## Jacoco

Java Code Coverage

jacoco呢是用于计算Java代码覆盖率的开源工具，可以帮助我们生成详细的测试覆盖报告，包含行覆盖率、分支覆盖率等等，可以和Maven/Gradle，以及IDEA/Eclipse集成使用



jacoco对于junit4和5都是支持的，只要确保引入各自的引擎，就能统计到



我们说一下Maven插件配置



然后我们看一下覆盖率报告的一些信息：

Missed Instructions ： 指令覆盖

branch Instructions： 分支覆盖

cxty：圈复杂度，覆盖所有可能情况最少使用的测试用例数 



常用指标：

分支覆盖率>60

方法圈复杂度 <=15

语句/行覆盖率 >=70



我们可以引入jacoco的maven插件，然后执行mvn clean test就可以生成代码覆盖率报告



遇到一个bug：即扫不到jupiter的Test 

解决：改成junit4的Test即可

猜想 可能不能同时用JU4和JU5



我们的这个map对应的是

数据库映射字段名---field

为什么这个地方拿不到 是因为 是要真正排序走逻辑才会遇到，













