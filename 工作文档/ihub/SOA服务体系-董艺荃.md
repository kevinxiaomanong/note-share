### 一、什么是SOA服务

使用携程SOA微服务框架开发、并在运行时使用SOA公共基础设施的应用



如果你想要创建 首先需要再SOA Poratal治理系统上注册

注册完会有元数据标识你的SOA服务

注意要用SOA公共基础设施开发 不然Service mash注册成功但是堡垒机验不到



 携程的SOA框架有两个

一个是CDubbo 一个是Baiji（SOA2.0）建议使用

Baiji的思想是契约优先，开发前我们先到mom上写契约，传输协议是Http



### 二、SOA机制

**运行机制**

SOA是基于注册中心Artemis 这样一套服务注册与发现的机制

![image-20240131163209062](D:\工作文档\ihub\assets\image-20240131163209062.png)



可以看到客户端和服务端都继承了SOA的SDK，服务端启动时会像Artemis去注册，一些元数据放上去

客户端启动时会去Artemis拉取服务的url列表，然后自行路由/负载均衡，选url发请求，所以客户端和服务端是直接联系的

然后熔断限流的一些功能其实是在filter里实现的，我们可以根据自身应用需要去在filter里实现一些功能



**路由机制**

路由三要素：

1、适用范围 操作请求*环境维度（APP ID、子环境）

2、路由算法 加权轮询 就近访问

3、路由目标 应用分组、IDC、CMS Group



### 三、SOA配置

SOA配置的方式很多，可以走properties配置文件（本地、qconfig），java代码配置，portal

收口到portal



熔断：

触发条件：请求数大于多少/失败率超过多少

分客户端熔断/服务端熔断 熔断了框架就会掐掉

生效粒度：服务端操作、客户端：服务+操作+服务端IP

熔断是会自行恢复的 过段时间会自己放行一个请求 如果成功了就恢复

熔断这块参考了Netflix的Hystrix



隔离：

避免单个操作占据过多系统资源

基于信号量，即比如某个服务的操作并发超过某阈值 就触发隔离



限流：

10s内一类请求数量超过阈值，返回429



黑白名单



超时：



### 四、Service Mesh

服务网格，核心目的是把负责网络通信、服务治理的东西从应用中剥离开(SDK)，和应用解耦

如果要对治理做升级，那么需要升级SDK，给开发造成额外负担

 service mesh本质是想让SDK与应用解耦，通过加一个中间层解决

好处是可以独立迭代，且让应用更轻，因为你把服务发现、治理等等功能剥离出去了



目前携程的Service Mesh是基于SideCar模型，即会有一个独立的sidecar进程，然后所有的服务请求会经过sidecar，由sidecar转发出去



那么应用如果接入Service Mesh

在Captain内有个service mesh的开关 打开后 重新发布即可



而后在SOA治理上的实例管理上会提示 由Service Mesh进行注册 而不是应用的SDK去注册

接入后 由SOA Operator把服务注册到Artemis，然后路由、负载、治理这些交给sidecar



交给Sidecar之后，那么客户端怎么知道调的是哪个服务端的IP呢，这服务端响应时会把这个信息返回，所以如果你看cat，前面记得是none 那说明请求失败，没有拿到响应 逻辑实例请求 



![image-20240201120830176](D:\工作文档\ihub\assets\image-20240201120830176.png)



可以看到其实还是注册到了Artmetis，然后由Operator同步到了Istio控制面





### 五、服务网关的机制

**SLB**

SLB 软负载均衡 主要用于HTTP协议，如果你需要对一个域名走路由 SLB比较适合

我们这边很多都是这样 去申请一个SLB的入口  然后通过域名访问即可

这个域名会被DNS解析到一套SLB上，这一套由OPS的GSLB负责管理 GSLB可以配置就近解析、比例解析



或者可能是多套SLB，由GSLB来管理，看这个域名的流量分到哪个机房



DR部署

--如果我们要接入DR部署的话

推荐先创建好一个IDC的group，建立好SLB访问入口，然后去创建DR GROUP去克隆到另一个IDC，这种方式会自动帮你把SLB的访问入口建好

而如果你是自己手动建两个 第二个会提示你域名已经存在 不会改变DNS指向

这种情况只能联系SRE人工支持



申请号SLB访问入口后会有一些报错

如果是相同URL随机404：那是未DR部署



**Gateway**

携程的业务服务网关系统，主要是将内网服务暴露到外网

例如 H5 Gateway 处理H5/Online/APP前端 的外网请求



为了防止接口数据意外暴露到外网，Gateway上针对调用有白名单机制



跨域、反爬、访问控制



**SLB VS Gateway**

SLB核心是路由+负载均衡，转发目标是一组服务器 不涉及业务逻辑

Gateway主要是路由，转发到一个URL，内含一些业务逻辑





### 六、UDL流量调度

保证一个用户的请求最终只会到一个region



UDL 用户数据归属地，取自用户注册时区域的后两位



用户请求--调度策略--目标区域































